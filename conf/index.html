<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueNAS Installer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-80 z-50">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-700 font-medium text-2xl">Connecting...</p>
        </div>
    </div>
    

    <script>
        class RPCClient {
            constructor(url) {
                this.ws = new WebSocket(url);
                this.pendingRequests = new Map();
                this.setupEventHandlers();
            }

            setupEventHandlers() {
                this.ws.onopen = (event) => {
                    document.querySelector('#loader p').textContent = 'Websocket is connected';
                    console.log('WebSocket connected', event);
                    this.onConnected();
                };

                this.ws.onmessage = (event) => {
                    try {
                        const response = JSON.parse(event.data);
                        this.handleResponse(response);
                    } catch (error) {
                        console.error('Failed to parse response:', error);
                    }
                };

                this.ws.onclose = (event) => {
                    document.getElementById('loader').classList.remove('hidden');
                    document.querySelector('#loader p').textContent = 'Websocket connection closed';
                    document.querySelector('#loader .animate-spin').classList.remove('animate-spin');
                    document.querySelector('#loader .animate-spin').innerHTML = '<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                    console.log('WebSocket closed');
                };

                this.ws.onerror = (error) => {
                    document.querySelector('#loader p').textContent = 'WebSocket connection failed';
                    console.error('WebSocket error:', error);
                };
            }

            call(method, params = []) {
                return new Promise((resolve, reject) => {
                    const id = this.generateUUID();
                    const request = {
                        id,
                        jsonrpc: '2.0',
                        method,
                        params
                    };

                    this.pendingRequests.set(id, { resolve, reject });
                    this.ws.send(JSON.stringify(request));
                });
            }

            handleResponse(response) {
                if (response.id && this.pendingRequests.has(response.id)) {
                    const { resolve, reject } = this.pendingRequests.get(response.id);
                    this.pendingRequests.delete(response.id);

                    if (response.error) {
                        reject(response.error);
                    } else {
                        resolve(response.result);
                    }
                }
            }

            async onConnected() {
                try {
                    let accessKey = ''
                    
                    const isAdopted = await this.call('is_adopted');
                    if (!isAdopted) {
                        accessKey = await this.call('adopt');
                        localStorage.setItem('accessKey', accessKey);
                    } else {
                        accessKey = localStorage.getItem('accessKey');
                    }

                    await this.call('authenticate', accessKey)
                    let tncConfig = await this.call('tnc_config')
                    if (!tncConfig.enabled) {
                        tncConfig = await this.call('configure_tnc', [{...config, enabled: true}]);    // NOTE: there should be at least ip address
                    }
                    if (tncConfig.claim_token_expiration < Math.floor(Date.now() / 1000)) {
                        // TODO: Claim token has expired. Try to re-insert the disc or ISO
                    }
                    console.log('TNC CONFIG', tncConfig)
                    const urlResult = await this.call('tnc_registration_uri');
                    console.log('URL RESULT', urlResult)
                    window.location.replace(`${urlResult}&installer_token=${accessKey}`)
                } catch (error) {
                    console.error('RPC call failed:', error);
                }
            }

            generateUUID() {
              // Check if the modern, secure crypto.randomUUID is available.
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
              }
            
              // Otherwise, fall back to a manual implementation.
              // This is a standard and reliable method for creating a UUID v4.
              // Courtesy of the original RFC4122 spec.
              return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
              });
            }
        }

        // Url params {config: encodeURIComponent('{"account_service_base_url":"***", "leca_service_base_url":"***", "tnc_base_url":"**", "heartbeat_service_base_url":"***"}')}
        // sample url params:  config=%7B%22account_service_base_url%22%3A%22http%3A%2F%2Faccount-service.dev.ixsystems.net%2Faccounts%22%2C%22heartbeat_service_base_url%22%3A%22http%3A%2F%2Faccount-service.dev.ixsystems.net%2Fheartbeat%22%2C%22leca_service_base_url%22%3A%22http%3A%2F%2Faccount-service.dev.ixsystems.net%2Fleca%22%2C%22tnc_base_url%22%3A%22https%3A%2F%2Ftruenas.connect.dev.ixsystems.net%2F%22%7D
    
        const urlParams = new URLSearchParams(window.location.search);
        const configParam = urlParams.get('config');
        const config = JSON.parse(decodeURIComponent(configParam))
        // const config = JSON.parse(decodeURIComponent('%7B%22account_service_base_url%22%3A%22https%3A%2F%2Faccount-service.dev.ixsystems.net%2F%22%2C%22leca_service_base_url%22%3A%22https%3A%2F%2Fdns-service.dev.ixsystems.net%2F%22%2C%22tnc_base_url%22%3A%22https%3A%2F%2Ftruenas.connect.dev.ixsystems.net%2F%22%7D')) // TODO: temporary
        if (!(config && config.account_service_base_url && config.leca_service_base_url && config.heartbeat_service_base_url && config.tnc_base_url)) {
            document.querySelector('#loader p').textContent = 'Missing required url parameters';
            document.querySelector('#loader .animate-spin').classList.remove('animate-spin');
            document.querySelector('#loader .animate-spin').innerHTML = '<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        } else {
            setTimeout(() => {
                const rpcClient = new RPCClient('ws://truenas-installer.local:8080/');
            }, 1000)
        }
    </script>
</body>

</html>